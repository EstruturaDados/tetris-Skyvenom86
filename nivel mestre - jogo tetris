#include <stdio.h>
#include <stdlib.h>
#include <time.h>

#define TAM_FILA 5
#define TAM_PILHA 3
#define HIST 10

typedef struct {
    char nome;
    int id;
} Peca;

// FILA
Peca fila[TAM_FILA];
int inicio = 0, fim = 0;

// PILHA RESERVA
Peca pilha[TAM_PILHA];
int topo = -1;

// HIST√ìRICO (para desfazer)
Peca histFila[HIST][TAM_FILA];
Peca histPilha[HIST][TAM_PILHA];
int histTopo = -1;

int proximoId = 1;

// ================= UTILIDADES =================

Peca gerarPeca() {
    char tipos[] = {'I','O','T','L'};
    Peca p;
    p.nome = tipos[rand() % 4];
    p.id = proximoId++;
    return p;
}

void salvarEstado() {
    if (histTopo < HIST - 1) {
        histTopo++;
        for (int i = 0; i < TAM_FILA; i++)
            histFila[histTopo][i] = fila[i];
        for (int i = 0; i <= topo; i++)
            histPilha[histTopo][i] = pilha[i];
    }
}

// ================= FILA =================

void enfileirar() {
    fila[fim] = gerarPeca();
    fim = (fim + 1) % TAM_FILA;
}

void jogarPeca() {
    salvarEstado();
    printf("\nüéÆ Pe√ßa jogada: [%c | %d]\n", fila[inicio].nome, fila[inicio].id);
    inicio = (inicio + 1) % TAM_FILA;
    enfileirar();
}

// ================= PILHA =================

void reservarPeca() {
    if (topo == TAM_PILHA - 1) {
        printf("\n‚ö†Ô∏è Pilha cheia!\n");
        return;
    }
    salvarEstado();
    pilha[++topo] = fila[inicio];
    printf("\nüì• Reservada: [%c | %d]\n", pilha[topo].nome, pilha[topo].id);
    inicio = (inicio + 1) % TAM_FILA;
    enfileirar();
}

void usarReservada() {
    if (topo == -1) {
        printf("\n‚ö†Ô∏è Pilha vazia!\n");
        return;
    }
    salvarEstado();
    printf("\nüì§ Usada da reserva: [%c | %d]\n", pilha[topo].nome, pilha[topo].id);
    topo--;
}

// ================= OPERA√á√ïES AVAN√áADAS =================

void trocarPecas() {
    if (topo == -1) {
        printf("\n‚ö†Ô∏è Pilha vazia para troca!\n");
        return;
    }
    salvarEstado();
    Peca temp = fila[inicio];
    fila[inicio] = pilha[topo];
    pilha[topo] = temp;
    printf("\nüîÑ Pe√ßas trocadas com sucesso!\n");
}

void desfazer() {
    if (histTopo < 0) {
        printf("\n‚ö†Ô∏è Nada para desfazer!\n");
        return;
    }
    for (int i = 0; i < TAM_FILA; i++)
        fila[i] = histFila[histTopo][i];
    for (int i = 0; i <= topo; i++)
        pilha[i] = histPilha[histTopo][i];
    histTopo--;
    printf("\n‚Ü©Ô∏è √öltima a√ß√£o desfeita!\n");
}

void inverterFila() {
    salvarEstado();
    for (int i = 0; i < TAM_FILA / 2; i++) {
        Peca temp = fila[(inicio + i) % TAM_FILA];
        fila[(inicio + i) % TAM_FILA] =
            fila[(inicio + TAM_FILA - 1 - i) % TAM_FILA];
        fila[(inicio + TAM_FILA - 1 - i) % TAM_FILA] = temp;
    }
    printf("\nüîÉ Fila invertida!\n");
}

// ================= EXIBI√á√ÉO =================

void mostrarFila() {
    printf("\nüì¶ FILA: ");
    for (int i = 0; i < TAM_FILA; i++) {
        int pos = (inicio + i) % TAM_FILA;
        printf("[%c|%d] ", fila[pos].nome, fila[pos].id);
    }
}

void mostrarPilha() {
    printf("\nüìö PILHA:\n");
    if (topo == -1) {
        printf(" [vazia]\n");
        return;
    }
    for (int i = topo; i >= 0; i--)
        printf(" [%c|%d]\n", pilha[i].nome, pilha[i].id);
}

// ================= MENU =================

void menu() {
    printf("\n\n====== TETRIS STACK ‚Äì N√çVEL MESTRE ======\n");
    printf("1 - Jogar pe√ßa\n");
    printf("2 - Reservar pe√ßa\n");
    printf("3 - Usar pe√ßa reservada\n");
    printf("4 - Trocar pe√ßa (fila ‚Üî pilha)\n");
    printf("5 - Desfazer √∫ltima jogada\n");
    printf("6 - Inverter fila\n");
    printf("0 - Sair\n");
    printf("Escolha: ");
}

// ================= MAIN =================

int main() {
    int op;
    srand(time(NULL));

    for (int i = 0; i < TAM_FILA; i++)
        enfileirar();

    do {
        menu();
        scanf("%d", &op);

        switch (op) {
            case 1: jogarPeca(); break;
            case 2: reservarPeca(); break;
            case 3: usarReservada(); break;
            case 4: trocarPecas(); break;
            case 5: desfazer(); break;
            case 6: inverterFila(); break;
            case 0: printf("\nüëã Encerrando...\n"); break;
            default: printf("\n‚ùå Op√ß√£o inv√°lida!\n");
        }

        mostrarFila();
        mostrarPilha();

    } while (op != 0);

    return 0;
}
